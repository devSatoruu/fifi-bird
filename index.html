<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FIFI: HORIZON FLIGHT ‚úàÔ∏è</title>

    <style>
        :root {
            --p: #ff4d6d; --s: #00d2ff; --g: #00ff41; --y: #f1c40f;
            --day-bg: #74b9ff; --sunset-bg: #ff7675; --night-bg: #0a192f;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; overflow: hidden; }

        body {
            background: #000; height: 100vh; width: 100vw;
            display: flex; justify-content: center; align-items: center;
        }

        #game-container {
            position: relative;
            width: 98vw; height: 98vh;
            background: var(--day-bg);
            transition: background 3s ease-in-out;
            border: 4px solid #333; border-radius: 8px;
            box-shadow: 0 0 100px rgba(0,0,0,0.8);
        }

        #star-container { position: absolute; inset: 0; opacity: 0; pointer-events: none; transition: opacity 2s; }
        .star {
            position: absolute; background: white; border-radius: 50%; width: 2px; height: 2px;
            animation: twinkle 2s infinite ease-in-out;
        }
        @keyframes twinkle { 0%, 100% { opacity: 0.3; transform: scale(1); } 50% { opacity: 1; transform: scale(1.5); } }

        .top-ui { position: absolute; top: 30px; width: 100%; display: flex; justify-content: space-around; align-items: center; z-index: 200; }
        .stat-box { background: rgba(0,0,0,0.7); padding: 10px 25px; border-radius: 50px; border: 2px solid rgba(255,255,255,0.1); backdrop-filter: blur(15px); color: white; font-weight: bold; font-size: 1.5rem; }

        #mute-btn { cursor: pointer; font-size: 1.5rem; background: rgba(0,0,0,0.5); border: none; padding: 10px; border-radius: 50%; color: white; }

        #plane {
            position: absolute; left: 150px; top: 50%; width: 60px; height: 60px;
            font-size: 50px; z-index: 100; display: flex; align-items: center; justify-content: center;
            filter: drop-shadow(0 10px 10px rgba(0,0,0,0.4));
        }

        .shield-active { outline: 6px solid var(--s); border-radius: 50%; box-shadow: 0 0 30px var(--s); }

        .obstacle {
            position: absolute; width: 80px; z-index: 5; border-radius: 15px;
            background: linear-gradient(90deg, #fff 0%, #e0e0e0 50%, #bbb 100%);
            border: 3px solid white; display: flex; align-items: center; justify-content: center;
            font-size: 2rem;
        }

        .item {
            position: absolute; width: 50px; height: 50px;
            display: flex; align-items: center; justify-content: center;
            font-size: 40px; z-index: 6;
            animation: float 2s infinite ease-in-out;
        }

        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-15px); } }

        .menu-overlay { position: absolute; inset: 0; background: rgba(0, 0, 0, 0.9); z-index: 300; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; color: white; }
        .btn-main { background: var(--p); color: white; padding: 20px 60px; border-radius: 60px; border: none; font-weight: 800; cursor: pointer; font-size: 2rem; margin-top: 20px; transition: 0.2s; }
        .btn-sub { background: var(--g); color: #000; padding: 15px 40px; border-radius: 50px; border: none; font-weight: 700; cursor: pointer; font-size: 1.2rem; margin-top: 10px; }

        #stage-announcer {
            position: absolute; width: 100%; top: 40%; text-align: center;
            z-index: 500; pointer-events: none; opacity: 0;
            transition: all 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        #stage-announcer.show { opacity: 1; transform: scale(1.1); }

        .victory-particle { position: absolute; font-size: 2rem; pointer-events: none; z-index: 400; animation: fall 3s linear forwards; }
        @keyframes fall { to { transform: translateY(110vh) rotate(720deg); opacity: 0; } }

        @keyframes rainbow {
            0% { background: #ff4d6d; } 25% { background: #f1c40f; } 50% { background: #00ff41; } 75% { background: #00d2ff; } 100% { background: #ff4d6d; }
        }
    </style>
</head>
<body onmousedown="handleInput(event)" onkeydown="if(event.code==='Space') handleInput(event)">

<audio id="bg-audio" src="bg-music.mp3" loop prefetch></audio>

<div id="game-container">
    <div id="star-container"></div>
    <div id="stage-announcer">
        <h2 id="stage-title" style="color:var(--y); text-transform:uppercase; font-size: 3rem; letter-spacing:5px;"></h2>
        <p id="stage-desc" style="font-size: 1.5rem; font-style:italic; opacity:0.8;"></p>
    </div>
    <div id="celestial" style="position: absolute; width: 150px; height: 150px; font-size: 130px; top: 60px; right: 10%; z-index: 1;">‚òÄÔ∏è</div>
    <div class="top-ui">
        <div class="stat-box">üíñ <span id="wallet">0</span></div>
        <button id="mute-btn" onclick="toggleMute(event)">üîä</button>
        <div class="stat-box">üìç <span id="distance">500</span>mi</div>
    </div>
    <div id="plane">‚úàÔ∏è</div>
    <div id="menu" class="menu-overlay">
        <h1 id="menu-title" style="color:var(--p); font-size: 5rem;">FIFI FLIGHT</h1>
        <p id="menu-sub" style="font-size: 1.5rem; opacity: 0.8;">500 Mile Journey</p>
        <div id="menu-buttons">
            <button class="btn-main" onclick="startGame(event)">START FLIGHT</button>
        </div>
    </div>
</div>

<script>
    const plane = document.getElementById('plane'),
        walletDisplay = document.getElementById('wallet'),
        distDisplay = document.getElementById('distance'),
        menu = document.getElementById('menu'),
        container = document.getElementById('game-container'),
        celestial = document.getElementById('celestial'),
        starField = document.getElementById('star-container'),
        announcer = document.getElementById('stage-announcer'),
        bgMusic = document.getElementById('bg-audio');

    let planeY, velocity, gameActive = false, distance = 500, frame = 0, hearts = 0, obstacles = [];
    let hasShield = false, magnetTimer = 0, stormTimer = 0, currentStage = -1;
    let isMuted = false;

    // Initialize Stars with variation
    for (let i = 0; i < 100; i++) {
        const star = document.createElement('div');
        star.className = 'star';
        star.style.left = Math.random() * 100 + '%';
        star.style.top = Math.random() * 100 + '%';
        star.style.animationDuration = (Math.random() * 3 + 1) + 's';
        star.style.animationDelay = (Math.random() * 2) + 's';
        starField.appendChild(star);
    }

    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    function playSound(freq, type, duration, vol=0.1) {
        if (isMuted) return;
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type = type;
        osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
        gain.gain.setValueAtTime(vol, audioCtx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration);
        osc.connect(gain); gain.connect(audioCtx.destination);
        osc.start(); osc.stop(audioCtx.currentTime + duration);
    }

    function toggleMute(e) {
        e.stopPropagation();
        isMuted = !isMuted;
        document.getElementById('mute-btn').innerText = isMuted ? 'üîá' : 'üîä';

        if (isMuted) {
            bgMusic.pause();
        } else if (gameActive) {
            bgMusic.play();
        }
    }

    let GRAVITY = 0.22, JUMP = -6.0, SCROLL_SPEED = 4.0, GAP_ADJ = 0.45;

    const stageData = [
        { name: "Clear Skies", desc: "Take it easy... ‚òÅÔ∏è", obs: "‚òÅÔ∏è", speed: 4, grav: 0.22, gap: 0.45, behavior: 'static' },
        { name: "Whispering Winds", desc: "Drifting clouds! üå¨Ô∏è", obs: "‚òÅÔ∏è", speed: 5.5, grav: 0.22, gap: 0.45, behavior: 'float' },
        { name: "Cumulus Climb", desc: "Tight squeeze! üéà", obs: "‚òÅÔ∏è", speed: 5, grav: 0.22, gap: 0.38, behavior: 'static' },
        { name: "Dusk Drifter", desc: "Heavy air... üåÖ", obs: "‚òÅÔ∏è", speed: 5, grav: 0.28, gap: 0.45, behavior: 'static' },
        { name: "Starlight Path", desc: "Wavy skies ‚ú®", obs: "‚≠ê", speed: 4.5, grav: 0.22, gap: 0.45, wavy: true, behavior: 'static' },
        { name: "Galaxy Crossing", desc: "Pulsing voids üåå", obs: "ü´ß", speed: 6.5, grav: 0.24, gap: 0.40, behavior: 'pulse' },
        { name: "Silver Lining", desc: "Closing in! üí™", obs: "ü´ß", speed: 7, grav: 0.22, gap: 0.48, behavior: 'close' },
        { name: "Aurora Breeze", desc: "Victory Lap! üåà", obs: "‚ú®", speed: 5, grav: 0.20, gap: 0.50, behavior: 'static' }
    ];

    function handleInput(e) {
        if (e && (e.target.tagName === 'BUTTON' || e.target.id === 'mute-btn')) return;
        if (gameActive) {
            velocity = JUMP;
            playSound(300, 'triangle', 0.2, 0.05);
            if (e && e.code === 'Space') e.preventDefault();
        }
    }

    function announceStage() {
        let stageIdx = Math.floor((500 - distance) / 75);
        if (stageIdx !== currentStage && stageIdx >= 0 && stageIdx < stageData.length) {
            currentStage = stageIdx;

            // --- NEW "PUSH" EFFECTS ---
            // 1. Brief flash effect
            container.style.filter = "brightness(2)";
            setTimeout(() => container.style.filter = "brightness(1)", 100);

            // 2. Plane thrust animation
            plane.style.left = "180px";
            setTimeout(() => plane.style.left = "150px", 400);

            // 3. Power-up sound
            playSound(600, 'sine', 0.5, 0.2);
            // ---------------------------


            let s = stageData[currentStage];
            SCROLL_SPEED = s.speed;
            GRAVITY = s.grav;
            GAP_ADJ = s.gap;
            document.getElementById('stage-title').innerText = s.name;
            document.getElementById('stage-desc').innerText = s.desc;
            announcer.classList.add('show');
            setTimeout(() => announcer.classList.remove('show'), 3000);
        }
    }

    function popShield() {
        hasShield = false;
        plane.classList.remove('shield-active');
        playSound(150, 'sawtooth', 0.5);
        velocity = JUMP;
    }

    function startGame(e, isContinue = false) {
        if(e) e.stopPropagation();
        if (audioCtx.state === 'suspended') audioCtx.resume();

        // Background Music Start
        if (!isMuted) {
            bgMusic.currentTime = 0;
            bgMusic.play().catch(err => console.log("Music play blocked", err));
        }

        gameActive = true;
        container.style.animation = "";
        menu.style.display = 'none';
        if(!isContinue) {
            distance = 500; hearts = 0; walletDisplay.innerText = "0";
            currentStage = -1;
            starField.style.opacity = "0";
        }
        planeY = container.offsetHeight / 2;
        velocity = JUMP; frame = 0; magnetTimer = 0; stormTimer = 0;
        hasShield = false; plane.classList.remove('shield-active');
        document.querySelectorAll('.obstacle, .item, .victory-particle').forEach(el => el.remove());
        obstacles = []; announceStage(); loop();
    }

    function spawn() {
        if (stormTimer > 0) return;
        const screenH = container.offsetHeight;
        const h = Math.floor(Math.random() * (screenH * 0.35)) + 50;
        const gap = screenH * GAP_ADJ;
        let obsEmoji = stageData[currentStage]?.obs || "‚òÅÔ∏è";

        const top = document.createElement('div'); top.className = 'obstacle'; top.style.height = h + 'px'; top.style.top = '0'; top.style.left = '100%'; top.innerText = obsEmoji;
        const bottom = document.createElement('div'); bottom.className = 'obstacle'; bottom.style.height = (screenH - h - gap) + 'px'; bottom.style.bottom = '0'; bottom.style.left = '100%'; bottom.innerText = obsEmoji;

        container.appendChild(top); container.appendChild(bottom);
        obstacles.push({ type: 'pipe', top, bottom, x: container.offsetWidth, h, gap, baseH: h, spawnFrame: frame });

        if (Math.random() > 0.3) {
            const itemEl = document.createElement('div'); itemEl.className = 'item';
            let r = Math.random();
            let itemType = (r > 0.92) ? 'üå©Ô∏è' : (r > 0.82 ? 'üõ°Ô∏è' : (r > 0.72 ? 'üß≤' : 'üíñ'));
            itemEl.innerHTML = itemType;
            let itemY = h + (gap / 2) - 25;
            container.appendChild(itemEl);
            obstacles.push({ type: 'item', el: itemEl, x: container.offsetWidth + 100, worldY: itemY, kind: itemType });
        }
    }

    function loop() {
        if (!gameActive) return;
        velocity += GRAVITY;
        planeY += velocity;

        let pitch = Math.max(-20, Math.min(velocity * 3, 20));
        plane.style.top = planeY + 'px';
        plane.style.transform = `rotateZ(${pitch}deg)`;

        if (distance > 400) { container.style.backgroundColor = "var(--day-bg)"; celestial.innerHTML = "‚òÄÔ∏è"; }
        else if (distance > 250) { container.style.backgroundColor = "var(--sunset-bg)"; celestial.innerHTML = "üåÖ"; starField.style.opacity = "0"; }
        else { container.style.backgroundColor = "var(--night-bg)"; celestial.innerHTML = "üåô"; starField.style.opacity = "1"; }

        if (planeY < -50 || planeY > container.offsetHeight - 50) {
            if (hasShield) { popShield(); planeY = (planeY < 0) ? 10 : container.offsetHeight - 80; }
            else { gameOver(); return; }
        }

        if (frame > 100 && frame % 90 === 0) spawn();
        frame++;

        for (let i = obstacles.length - 1; i >= 0; i--) {
            let o = obstacles[i];
            if (o.type === 'item') {
                if (magnetTimer > 0) {
                    o.x += (150 - o.x) * 0.15;
                    o.worldY += (planeY - o.worldY) * 0.15;
                } else { o.x -= SCROLL_SPEED; }
                o.el.style.left = o.x + 'px'; o.el.style.top = o.worldY + 'px';
                if (o.x < 210 && o.x > 90 && Math.abs(planeY - o.worldY) < 60) {
                    if (o.kind === 'üíñ') { hearts++; walletDisplay.innerText = hearts; playSound(800, 'sine', 0.1); }
                    else if (o.kind === 'üõ°Ô∏è') { hasShield = true; plane.classList.add('shield-active'); playSound(400, 'sawtooth', 0.3); }
                    else if (o.kind === 'üß≤') { magnetTimer = 400; playSound(600, 'sine', 0.4); }
                    else if (o.kind === 'üå©Ô∏è') {
                        stormTimer = 300; playSound(200, 'sawtooth', 0.5);
                        document.querySelectorAll('.obstacle').forEach(cloud => cloud.style.opacity = "0");
                        setTimeout(() => { obstacles = obstacles.filter(obs => obs.type !== 'pipe'); document.querySelectorAll('.obstacle').forEach(c => c.remove()); }, 100);
                    }
                    o.el.remove(); obstacles.splice(i, 1);
                }
            } else {
                o.x -= SCROLL_SPEED;
                let currentH = o.h;
                let currentGap = o.gap;
                let behavior = stageData[currentStage]?.behavior;

                if (stageData[currentStage]?.wavy) {
                    currentH = o.baseH + (Math.sin(frame * 0.05) * 50);
                } else if (behavior === 'float') {
                    currentH = o.baseH + (Math.sin((frame - o.spawnFrame) * 0.03) * 30);
                } else if (behavior === 'pulse') {
                    let pulse = Math.sin((frame - o.spawnFrame) * 0.05) * 20;
                    currentH = o.baseH + pulse;
                    currentGap = o.gap - (pulse * 2);
                } else if (behavior === 'close' && o.x < container.offsetWidth * 0.6) {
                    let factor = Math.min(1, (container.offsetWidth * 0.6 - o.x) / 300);
                    currentGap = o.gap - (40 * factor);
                    currentH = o.baseH + (20 * factor);
                }

                o.top.style.height = currentH + 'px';
                o.bottom.style.height = (container.offsetHeight - currentH - currentGap) + 'px';
                o.top.style.left = o.x + 'px'; o.bottom.style.left = o.x + 'px';

                if (o.x < 210 && o.x > 120) {
                    if (planeY < currentH || planeY > (currentH + currentGap - 60)) {
                        if (hasShield) { popShield(); o.x = -500; o.top.remove(); o.bottom.remove(); }
                        else { gameOver(); return; }
                    }
                }
            }
            if (o.x < -150) { if (o.type === 'item') o.el.remove(); else { o.top.remove(); o.bottom.remove(); } obstacles.splice(i, 1); }
        }

        if (magnetTimer > 0) magnetTimer--;
        if (stormTimer > 0) stormTimer--;
        if (frame % 40 === 0) { distance = Math.max(0, distance - 1); distDisplay.innerText = distance; announceStage(); }
        if (distance <= 0) { win(); return; }
        requestAnimationFrame(loop);
    }

    function gameOver() {
        gameActive = false;
        bgMusic.pause();
        playSound(100, 'square', 0.8, 0.2);
        document.getElementById('menu-title').innerText = "CRASHED!";
        document.getElementById('menu-sub').innerText = `You flew ${500 - distance} miles`;
        let btns = `<button class="btn-main" onclick="location.reload()">TRY AGAIN</button>`;
        if (hearts >= 20) btns += `<br><button class="btn-sub" onclick="useContinue()">CONTINUE (20 üíñ)</button>`;
        document.getElementById('menu-buttons').innerHTML = btns;
        menu.style.display = 'flex';
    }

    function useContinue() {
        hearts -= 20;
        walletDisplay.innerText = hearts;
        document.getElementById('menu-buttons').innerHTML = `<button class="btn-main" onclick="startGame(event)">START FLIGHT</button>`;
        startGame(null, true);
    }

    function win() {
        gameActive = false;
        bgMusic.pause();
        container.style.animation = "rainbow 2s infinite linear";
        plane.style.transition = "all 2s ease-in-out";
        plane.style.left = "50%";
        plane.style.top = "50%";
        plane.style.transform = "translate(-50%, -50%) scale(2) rotate(360deg)";

        // Confetti effect
        const emojis = ['üíñ', '‚ú®', '‚≠ê', 'üéà', '‚úàÔ∏è'];
        for(let i=0; i<50; i++) {
            setTimeout(() => {
                const p = document.createElement('div');
                p.className = 'victory-particle';
                p.innerText = emojis[Math.floor(Math.random()*emojis.length)];
                p.style.left = Math.random() * 100 + 'vw';
                p.style.top = '-50px';
                container.appendChild(p);
                playSound(400 + (Math.random()*600), 'sine', 0.2, 0.05);
            }, i * 100);
        }

        setTimeout(() => {
            playSound(1000, 'sine', 1, 0.2);
            menu.innerHTML = `<h1 style="color:var(--y); font-size: 5rem; text-shadow: 0 0 20px #fff;">LANDED SAFELY! ‚ù§Ô∏è</h1>
            <p style="font-size: 2rem; margin: 20px;">You completed the 500 mile journey!</p>
            <button class="btn-main" onclick="location.reload()">FLY AGAIN</button>`;
            menu.style.display = 'flex';
        }, 3000);
    }
</script>
</body>
</html>